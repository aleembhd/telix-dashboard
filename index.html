<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client-Telecaller Management Dashboard</title>
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#000000">
    <meta name="description" content="A dashboard for managing client-telecaller relationships">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Telix Dashboard">
    
    <!-- Additional status bar color for Android -->
    <meta name="msapplication-TileColor" content="#000000">
    <meta name="msapplication-navbutton-color" content="#000000">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="152x152" href="icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icons/icon-192x192.png">
    <link rel="apple-touch-icon" sizes="167x167" href="icons/icon-152x152.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-72x72.png">
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #000000;
            --accent-color: #f39c12;
            --accent-hover: #e67e22;
            --secondary-color: #2ecc71;
            --secondary-dark: #27ae60;
            --danger-color: #e74c3c;
            --light-gray: #f5f7fa;
            --medium-gray: #e1e5eb;
            --dark-gray: #4a5568;
            --text-color: #2d3748;
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: #000000;
            color: var(--text-color);
            padding: 0;
            margin: 0;
            min-height: 100vh;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            padding: 20px 0;
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: #000000;
        }
        
        /* Additional styling to force black status bar */
        @media screen and (display-mode: standalone) {
            html, body {
                background-color: #000000;
            }
            
            header::before {
                content: '';
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                height: 100px; /* Cover status bar height */
                background-color: #000000;
                z-index: 9;
            }
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.3rem;
            font-weight: 700;
            color: white;
        }

        .card {
            background-color: #191919;
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
            position: relative;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            cursor: pointer;
            border-left: 3px solid var(--accent-color);
        }

        .card-title {
            color: white;
            font-size: 1.1rem;
            font-weight: 500;
        }

        .card-subtitle {
            color: #888;
            font-size: 0.85rem;
            margin-top: 4px;
        }

        .card-button {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: var(--accent-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            font-size: 20px;
            transition: background-color 0.2s;
        }

        .card-button:hover {
            background-color: var(--accent-hover);
        }

        .card-content {
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
        }

        .card-content.active {
            padding: 20px;
            max-height: 2000px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: #ddd;
        }

        input[type="text"],
        input[type="tel"],
        input[type="password"],
        select {
            width: 100%;
            padding: 12px;
            background-color: #333;
            color: white;
            border: 1px solid #444;
            border-radius: 4px;
            font-size: 1rem;
        }

        input::placeholder {
            color: #777;
        }

        .button {
            display: inline-block;
            padding: 12px 20px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .button:hover {
            background-color: var(--accent-hover);
        }

        .button.secondary {
            background-color: var(--secondary-color);
        }

        .button.secondary:hover {
            background-color: var(--secondary-dark);
        }

        .button.danger {
            background-color: var(--danger-color);
        }

        .telecaller-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 8px;
            margin-top: 16px;
        }

        .telecaller-button {
            aspect-ratio: 1;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: 500;
            background-color: #333;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .telecaller-button.available {
            background-color: #333;
            border: 1px solid #444;
        }

        .telecaller-button.selected {
            background-color: #2ecc71;
            color: white;
        }

        .telecaller-button.assigned {
            background-color: var(--secondary-color);
            color: white;
        }

        .telecaller-button.frozen {
            background-color: #f39c12;
            color: white;
            opacity: 1;
            cursor: not-allowed;
        }

        .action-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 24px;
        }

        .telecaller-status {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: #ddd;
        }

        .status-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }

        .status-color.available {
            background-color: #333;
            border: 1px solid #444;
        }

        .status-color.selected {
            background-color: #2ecc71;
        }

        .status-color.assigned {
            background-color: var(--secondary-color);
        }

        .status-color.frozen {
            background-color: #f39c12;
            opacity: 1;
        }

        @media (max-width: 768px) {
            .telecaller-grid {
                grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
            }

            .action-buttons {
                flex-direction: column;
            }

            .button {
                width: 100%;
                text-align: center;
            }
        }

        @media (max-width: 480px) {
            .telecaller-grid {
                grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            }

            .card-content.active {
                padding: 15px;
            }

            .header-content {
                flex-direction: column;
                gap: 8px;
            }
        }
        
        #existingClientsList {
            list-style: none;
            padding: 0;
        }
        
        .client-item {
            background-color: #333;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 4px;
            cursor: pointer;
            color: white;
            display: flex;
            justify-content: space-between;
        }
        
        .client-item:hover {
            background-color: #444;
        }
        
        .client-name {
            font-weight: 500;
        }
        
        .client-phone {
            color: #bbb;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">Client-Telecaller Dashboard</div>
            </div>
        </div>
    </header>

    <main class="container">
        <!-- Add New Client Card -->
        <div class="card" id="addClientCard">
            <div class="card-header" onclick="toggleCard('addClientContent'); freezeAssignedTelecallerButtons();">
                <div>
                    <div class="card-title">Add New Client</div>
                    <div class="card-subtitle">Quickly add a new client to the system</div>
                </div>
                <button class="card-button" onclick="toggleCard('addClientContent', event); freezeAssignedTelecallerButtons();">+</button>
            </div>
            <div class="card-content" id="addClientContent">
                <div class="form-group">
                    <label for="clientName">Client Name</label>
                    <input type="text" id="clientName" placeholder="Enter client name">
                </div>
                <div class="form-group">
                    <label for="clientPhone">Client Phone Number</label>
                    <input type="tel" id="clientPhone" placeholder="Enter phone number">
                </div>

                <div class="form-group">
                    <label>Assign Telecallers</label>
                    
                    <div class="telecaller-status">
                        <div class="status-item">
                            <div class="status-color available"></div>
                            <span>Available</span>
                        </div>
                        <div class="status-item">
                            <div class="status-color selected"></div>
                            <span>Selected</span>
                        </div>
                        <div class="status-item">
                            <div class="status-color frozen"></div>
                            <span>Assigned to Client</span>
                        </div>
                    </div>
                    
                    <!-- Telecaller count display -->
                    <div style="margin: 10px 0; color: #ddd; font-size: 0.9rem; background-color: #2a2a2a; padding: 8px 12px; border-radius: 4px; display: flex; justify-content: space-between;">
                        <span>Available: <span id="newClientAvailableCount">0</span></span>
                        <span>Selected: <span id="newClientSelectedCount">0</span></span>
                        <span>Assigned: <span id="newClientAssignedCount">0</span></span>
                    </div>

                    <div class="telecaller-grid" id="newClientTelecallerGrid">
                        <!-- Telecaller buttons will be generated here -->
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="button" id="addClientBtn">Add Client</button>
                </div>
            </div>
        </div>

        <!-- Update Existing Client Card -->
        <div class="card" id="existingClientsCard">
            <div class="card-header" onclick="toggleCard('existingClientsContent')">
                <div>
                    <div class="card-title">Existing Clients</div>
                    <div class="card-subtitle">Manage and update existing clients</div>
                </div>
                <button class="card-button" onclick="toggleCard('existingClientsContent', event)">+</button>
            </div>
            <div class="card-content" id="existingClientsContent">
                <ul id="existingClientsList">
                    <!-- Client list will be populated here dynamically -->
                </ul>
                
                <div id="clientUpdateForm" style="display: none; margin-top: 20px;">
                    <h3 style="color: white; margin-bottom: 15px;">Update Client</h3>
                    <div class="form-group">
                        <label for="updateClientName">Client Name</label>
                        <input type="text" id="updateClientName" placeholder="Enter client name">
                    </div>
                    <div class="form-group">
                        <label for="updateClientPhone">Client Phone Number</label>
                        <input type="tel" id="updateClientPhone" placeholder="Enter phone number">
                    </div>

                    <div class="form-group">
                        <label>Manage Telecallers</label>
                        
                        <div class="telecaller-status">
                            <div class="status-item">
                                <div class="status-color available"></div>
                                <span>Available</span>
                            </div>
                            <div class="status-item">
                                <div class="status-color selected"></div>
                                <span>Selected</span>
                            </div>
                            <div class="status-item">
                                <div class="status-color frozen"></div>
                                <span>Assigned to Client</span>
                            </div>
                        </div>
                        
                        <!-- Telecaller count display -->
                        <div style="margin: 10px 0; color: #ddd; font-size: 0.9rem; background-color: #2a2a2a; padding: 8px 12px; border-radius: 4px; display: flex; justify-content: space-between;">
                            <span>Available: <span id="updateClientAvailableCount">0</span></span>
                            <span>Selected: <span id="updateClientSelectedCount">0</span></span>
                            <span>Assigned: <span id="updateClientAssignedCount">0</span></span>
                        </div>

                        <div class="telecaller-grid" id="updateClientTelecallerGrid">
                            <!-- Telecaller buttons will be generated here -->
                        </div>
                        
                        <!-- New section to display telecaller names -->
                        <div class="selected-telecallers-container" style="margin-top: 20px; color: #ddd; background-color: #2a2a2a; border-radius: 4px; padding: 15px; display: none;" id="selectedTelecallersContainer">
                            <h4 style="margin-bottom: 10px; color: var(--accent-color);">Selected Telecallers</h4>
                            <ul id="selectedTelecallersList" style="list-style: none; padding: 0;">
                                <!-- Selected telecaller names will be displayed here -->
                            </ul>
                        </div>
                    </div>

                    <div class="action-buttons">
                        <button class="button secondary" id="updateClientBtn">Update Client</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Telecaller Settings Card -->
        <div class="card" id="telecallerSettingsCard">
            <div class="card-header" onclick="toggleCard('telecallerSettingsContent')">
                <div>
                    <div class="card-title">Telecaller Settings</div>
                    <div class="card-subtitle">Update telecaller limit and settings</div>
                </div>
                <button class="card-button" onclick="toggleCard('telecallerSettingsContent', event)">+</button>
            </div>
            <div class="card-content" id="telecallerSettingsContent">
                <div class="form-group">
                    <label for="telecallerLimit">Telecaller Limit</label>
                    <input type="number" id="telecallerLimit" placeholder="Enter telecaller limit" min="1" max="100" style="background-color: #333; color: white; border: 1px solid #444; border-radius: 4px; font-size: 1rem; padding: 12px; width: 100%;">
                    <small style="color: #888; display: block; margin-top: 5px;">Current limit: <span id="currentTelecallerLimit">50</span></small>
                </div>

                <div class="action-buttons">
                    <button class="button" id="updateTelecallerLimitBtn">Update Settings</button>
                </div>
            </div>
        </div>
    </main>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script>
        // Firebase configuration - use your existing Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyCLrrkbXcW-exG8_n4kOEmzA-SETMWqo-0",
            authDomain: "feedbackapp-5904d.firebaseapp.com",
            databaseURL: "https://feedbackapp-5904d-default-rtdb.firebaseio.com",
            projectId: "feedbackapp-5904d",
            storageBucket: "feedbackapp-5904d.firebasestorage.app",
            messagingSenderId: "620175464767",
            appId: "1:620175464767:web:8054286a27a26210619b8a",
            measurementId: "G-QH8JN7TE0J"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        // Store telecaller names from Firebase
        let telecallerNames = {};

        // Fetch telecaller names from Firebase
        function fetchTelecallerNames() {
            const namesRef = firebase.database().ref('telecallerNames');
            namesRef.once('value')
                .then(snapshot => {
                    telecallerNames = snapshot.val() || {};
                    console.log('Fetched telecaller names:', telecallerNames);
                })
                .catch(error => {
                    console.error('Error fetching telecaller names:', error);
                });
        }

        // Fetch clients from Firebase and display them
        function fetchClients() {
            const clientsRef = firebase.database().ref('clients');
            clientsRef.once('value')
                .then(snapshot => {
                    const clients = snapshot.val() || {};
                    const clientsList = document.getElementById('existingClientsList');
                    
                    // Clear the current list
                    clientsList.innerHTML = '';
                    
                    // Add each client to the list
                    Object.keys(clients).forEach(clientId => {
                        const client = clients[clientId];
                        const li = document.createElement('li');
                        li.className = 'client-item';
                        li.setAttribute('data-client-id', clientId);
                        li.onclick = function() { selectClient(clientId); };
                        
                        li.innerHTML = `
                            <div class="client-name">${client.name}</div>
                            <div class="client-phone">${client.phoneNumber}</div>
                        `;
                        
                        clientsList.appendChild(li);
                    });
                })
                .catch(error => {
                    console.error('Error fetching clients:', error);
                });
        }

        // Convert number to word for telecaller keys (1 -> One, 2 -> Two, etc.)
        function getNumberWord(num) {
            const words = ['Zero', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine', 'Ten', 
                          'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 
                          'Nineteen', 'Twenty'];
                          
            if (num <= 20) return words[num];
            return num.toString();
        }

        // Update the displayed telecaller names based on selected buttons
        function updateSelectedTelecallersList(selectedIds) {
            const container = document.getElementById('selectedTelecallersContainer');
            const list = document.getElementById('selectedTelecallersList');
            
            // Clear the existing list
            list.innerHTML = '';
            
            if (selectedIds.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            // Sort the IDs numerically
            selectedIds.sort((a, b) => a - b);
            
            // Create list items for each selected telecaller
            selectedIds.forEach(id => {
                const nameKey = `telecaller${getNumberWord(id)}`;
                const displayName = telecallerNames[nameKey] || `Telecaller ${id}`;
                
                const listItem = document.createElement('li');
                listItem.style.padding = '8px 10px';
                listItem.style.marginBottom = '5px';
                listItem.style.backgroundColor = '#333';
                listItem.style.borderRadius = '4px';
                listItem.style.display = 'flex';
                listItem.style.justifyContent = 'space-between';
                listItem.style.alignItems = 'center';
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = `${id}: ${displayName}`;
                
                const removeBtn = document.createElement('button');
                removeBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                    <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                </svg>`;
                removeBtn.style.background = 'none';
                removeBtn.style.border = 'none';
                removeBtn.style.color = '#ff6b6b';
                removeBtn.style.cursor = 'pointer';
                removeBtn.style.padding = '0 5px';
                removeBtn.style.display = 'flex';
                removeBtn.style.alignItems = 'center';
                removeBtn.title = 'Remove telecaller';
                
                // Add click event to remove this telecaller with CAPTCHA verification
                removeBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    
                    // Show confirmation message with CAPTCHA
                    const captcha = generateMathCaptcha(false); // Use subtraction for deletion
                    
                    // Show detailed confirmation
                    const confirmMsg = `Are you absolutely sure you want to remove Telecaller #${id} (${displayName}) from this client?\n\nThis action will unassign this telecaller.\n\nTo confirm, please solve: ${captcha.question}`;
                    
                    const userAnswer = prompt(confirmMsg);
                    
                    // Verify answer
                    if (userAnswer === null) {
                        // User cancelled
                        return;
                    }
                    
                    const numAnswer = parseInt(userAnswer.trim());
                    if (isNaN(numAnswer) || numAnswer !== captcha.answer) {
                        alert('Incorrect answer. Telecaller was not removed.');
                        return;
                    }
                    
                    // Correct answer, proceed with removal
                    // Find and unselect the corresponding button in the grid
                    const button = document.querySelector(`#updateClientTelecallerGrid [data-telecaller-id="${id}"]`);
                    if (button) {
                        button.classList.remove('selected');
                        button.classList.add('available');
                    }
                    
                    // Update the list
                    const newSelectedIds = selectedIds.filter(selectedId => selectedId !== id);
                    updateSelectedTelecallersList(newSelectedIds);
                    
                    // Update telecaller counts
                    updateTelecallerCounts('existingClientsContent');
                });
                
                listItem.appendChild(nameSpan);
                listItem.appendChild(removeBtn);
                list.appendChild(listItem);
            });
            
            // Show the container
            container.style.display = 'block';
        }

        // Toggle card expand/collapse
        function toggleCard(contentId, event) {
            if (event) {
                event.stopPropagation();
            }
            
            // Close all other cards first
            if (contentId === 'addClientContent') {
                document.getElementById('existingClientsContent').classList.remove('active');
                document.getElementById('telecallerSettingsContent').classList.remove('active');
                
                // When opening Add New Client card, freeze all already assigned telecaller buttons
                freezeAssignedTelecallerButtons();
                
                // Update telecaller counts
                updateTelecallerCounts('addClientContent');
            } else if (contentId === 'existingClientsContent') {
                document.getElementById('addClientContent').classList.remove('active');
                document.getElementById('telecallerSettingsContent').classList.remove('active');
                // Hide the client update form when toggling the existing clients card
                document.getElementById('clientUpdateForm').style.display = 'none';
            } else if (contentId === 'telecallerSettingsContent') {
                document.getElementById('addClientContent').classList.remove('active');
                document.getElementById('existingClientsContent').classList.remove('active');
            }
            
            // Toggle the requested card
            const content = document.getElementById(contentId);
            content.classList.toggle('active');
        }
        
        // Store all assigned telecaller buttons globally
        let globalAssignedTelecallers = new Set();

        // Collect all assigned telecaller buttons and freeze them in the Add New Client card
        function freezeAssignedTelecallerButtons() {
            // First reset all buttons to available state
            resetTelecallerButtons('newClientTelecallerGrid');
            
            // Use the globally stored assigned telecallers
            console.log('Using globally stored assigned telecallers:', Array.from(globalAssignedTelecallers));
            
            // Freeze all assigned telecaller buttons
            globalAssignedTelecallers.forEach(buttonId => {
                const button = document.querySelector(`#newClientTelecallerGrid [data-telecaller-id="${buttonId}"]`);
                if (button) {
                    button.classList.remove('available');
                    button.classList.add('frozen');
                }
            });
            
            // Update telecaller counts
            updateTelecallerCounts('addClientContent');
        }
        
        // Fetch all assigned telecaller buttons from all clients
        function fetchAllAssignedTelecallers() {
            // Clear the global set first
            globalAssignedTelecallers.clear();
            
            // Fetch all clients to collect assigned telecallers
            return firebase.database().ref('clients').once('value')
                .then(snapshot => {
                    const clients = snapshot.val() || {};
                    
                    // Collect all assigned telecallers from all clients
                    Object.values(clients).forEach(client => {
                        if (client.includedButtons && Array.isArray(client.includedButtons)) {
                            client.includedButtons.forEach(buttonId => {
                                globalAssignedTelecallers.add(buttonId);
                            });
                        }
                    });
                    
                    console.log('Fetched all assigned telecallers:', Array.from(globalAssignedTelecallers));
                    return globalAssignedTelecallers; // Return the set for chaining
                })
                .catch(error => {
                    console.error('Error fetching assigned telecallers:', error);
                    return new Set(); // Return empty set on error
                });
        }
        
        // Select client for updating
        function selectClient(clientId) {
            // Get the clicked client element
            const clickedClientElement = document.querySelector(`.client-item[data-client-id="${clientId}"]`);
            
            // Check if this client is already selected
            const isAlreadySelected = clickedClientElement.classList.contains('active');
            
            // If already selected, toggle off the form and remove active class
            if (isAlreadySelected) {
                document.getElementById('clientUpdateForm').style.display = 'none';
                clickedClientElement.classList.remove('active');
                return;
            }
            
            // Hide any previously shown client form first
            document.getElementById('clientUpdateForm').style.display = 'none';
            
            // Remove any "active" class from previously selected client
            const activeClients = document.querySelectorAll('.client-item.active');
            activeClients.forEach(client => {
                client.classList.remove('active');
            });
            
            // Add active class to the clicked client
            if (clickedClientElement) {
                clickedClientElement.classList.add('active');
            }
            
            // Load client data from Firebase
            firebase.database().ref('clients/' + clientId).once('value')
                .then(snapshot => {
                    const clientData = snapshot.val();
                    if (clientData) {
            // Show the update form
            document.getElementById('clientUpdateForm').style.display = 'block';
            
                        // Populate form with client data
                        document.getElementById('updateClientName').value = clientData.name || '';
                        document.getElementById('updateClientPhone').value = clientData.phoneNumber || '';
                
                // Reset all buttons then select the appropriate ones
                resetTelecallerButtons('updateClientTelecallerGrid');
                        const assignedTelecallers = clientData.includedButtons || [];
                selectTelecallerButtons('updateClientTelecallerGrid', assignedTelecallers);
                
                // Update the telecaller names list
                updateSelectedTelecallersList(assignedTelecallers);
                
                // Update telecaller counts
                updateTelecallerCounts('existingClientsContent');
                        
                        // Store the client ID for update
                        document.getElementById('updateClientBtn').setAttribute('data-client-id', clientId);
                    } else {
                        console.error('Client not found:', clientId);
                        alert('Client not found');
                    }
                })
                .catch(error => {
                    console.error('Error loading client data:', error);
                    alert('Error loading client data: ' + error.message);
                });
        }
        
        // Reset all telecaller buttons to available
        function resetTelecallerButtons(containerId) {
            const buttons = document.querySelectorAll(`#${containerId} .telecaller-button`);
            buttons.forEach(button => {
                button.classList.remove('selected', 'frozen');
                button.classList.add('available');
            });
        }
        
        // Select specific telecaller buttons
        function selectTelecallerButtons(containerId, telecallerIds) {
            telecallerIds.forEach(id => {
                const button = document.querySelector(`#${containerId} [data-telecaller-id="${id}"]`);
                if (button) {
                    button.classList.remove('available');
                    button.classList.add('selected');
                }
            });
        }

        // Generate telecaller buttons (1-50)
        function generateTelecallerButtons(containerId, limit) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            for (let i = 1; i <= (limit || 50); i++) {
                const button = document.createElement('button');
                button.className = 'telecaller-button available';
                button.setAttribute('data-telecaller-id', i);
                button.textContent = i;
                
                // Add click event to toggle selection
                button.addEventListener('click', function() {
                    // Don't allow clicking frozen buttons
                    if (this.classList.contains('frozen')) return;
                    
                    // For update client grid, require CAPTCHA verification
                    if (containerId === 'updateClientTelecallerGrid') {
                        const isCurrentlyAvailable = this.classList.contains('available');
                        const captcha = generateMathCaptcha(isCurrentlyAvailable); // Addition for selecting, subtraction for deselecting
                        
                        // Show the CAPTCHA alert
                        const userAnswer = prompt(`Security Check: Please solve this math problem to ${isCurrentlyAvailable ? 'add' : 'remove'} telecaller #${i}\n\n${captcha.question}`);
                        
                        // Verify answer
                        if (userAnswer === null) {
                            // User cancelled
                            return;
                        }
                        
                        const numAnswer = parseInt(userAnswer.trim());
                        if (isNaN(numAnswer) || numAnswer !== captcha.answer) {
                            alert('Incorrect answer. Telecaller was not ' + (isCurrentlyAvailable ? 'added' : 'removed') + '.');
                            return;
                        }
                        
                        // Correct answer, proceed with toggle
                        this.classList.toggle('selected');
                        this.classList.toggle('available');
                        
                        const selectedButtons = document.querySelectorAll('#updateClientTelecallerGrid .telecaller-button.selected');
                        const selectedIds = Array.from(selectedButtons).map(btn => 
                            parseInt(btn.getAttribute('data-telecaller-id'))
                        );
                        
                        updateSelectedTelecallersList(selectedIds);
                        
                        // Update telecaller counts for update client
                        updateTelecallerCounts('existingClientsContent');
                    } else {
                        // For new client grid, no CAPTCHA needed
                        this.classList.toggle('selected');
                        this.classList.toggle('available');
                        
                        // Update telecaller counts for new client
                        updateTelecallerCounts('addClientContent');
                    }
                });
                
                container.appendChild(button);
            }
            
            // Update initial counts
            if (containerId === 'newClientTelecallerGrid') {
                updateTelecallerCounts('addClientContent');
            } else {
                updateTelecallerCounts('existingClientsContent');
            }
        }

        // Migrate existing clients to new format
        function migrateExistingClients() {
            firebase.database().ref('clients').once('value')
                .then(snapshot => {
                    const clients = snapshot.val() || {};
                    const updates = {};
                    const removes = [];
                    let needsUpdate = false;
                    let maxClientNumber = 0;
                    
                    // First pass: find highest client number
                    Object.keys(clients).forEach(clientId => {
                        if (clientId.match(/^client\d+$/)) {
                            const clientNumber = parseInt(clientId.replace('client', ''));
                            if (!isNaN(clientNumber) && clientNumber > maxClientNumber) {
                                maxClientNumber = clientNumber;
                            }
                        }
                    });
                    
                    // Second pass: process each client
                    Object.keys(clients).forEach(clientId => {
                        const client = clients[clientId];
                        
                        // Fix includedButtons format if needed
                        if (client.includedButtons && typeof client.includedButtons === 'object' && !Array.isArray(client.includedButtons)) {
                            const buttonArray = Object.values(client.includedButtons).map(val => parseInt(val));
                            
                            // If clientId already has correct format, just update includedButtons
                            if (clientId.match(/^client\d+$/)) {
                                updates['clients/' + clientId + '/includedButtons'] = buttonArray;
                                needsUpdate = true;
                            } else {
                                // We'll create a new client with correct ID format below
                                client.includedButtons = buttonArray;
                            }
                        }
                        
                        // If client ID doesn't match required format, create a new one with correct format
                        if (!clientId.match(/^client\d+$/)) {
                            maxClientNumber++;
                            const newClientId = 'client' + maxClientNumber;
                            
                            // Add the client with new ID
                            updates['clients/' + newClientId] = client;
                            
                            // Mark old client for removal
                            removes.push(clientId);
                            
                            needsUpdate = true;
                        }
                    });
                    
                    // Apply updates if needed
                    if (needsUpdate) {
                        return firebase.database().ref().update(updates)
                            .then(() => {
                                // Remove old clients that were migrated
                                const removePromises = removes.map(oldClientId => {
                                    return firebase.database().ref('clients/' + oldClientId).remove();
                                });
                                
                                return Promise.all(removePromises);
                            });
                    }
                    
                    return Promise.resolve();
                })
                .then(() => {
                    console.log('Migration completed successfully (if needed)');
                })
                .catch(error => {
                    console.error('Error during migration:', error);
                });
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            // Immediately start fetching assigned telecallers (moved to the top for priority)
            const assignedTelecallersPromise = fetchAllAssignedTelecallers();
            
            // Fetch telecaller names from Firebase
            fetchTelecallerNames();
            
            // Migrate existing clients to new format
            migrateExistingClients();
            
            // Fetch existing clients from Firebase
            fetchClients();
            
            // Fetch telecaller settings and generate telecaller buttons with assigned ones frozen
            firebase.database().ref('telecaller_settings').once('value')
                .then(snapshot => {
                    const settings = snapshot.val() || {};
                    const totalTelecallers = settings.total_telecallers_count || 50;
                    
                    // Wait for assigned telecallers to be fetched before generating buttons
                    return assignedTelecallersPromise.then(() => {
                        // Generate telecaller buttons with the limit from settings
                        generateTelecallerButtons('newClientTelecallerGrid', totalTelecallers);
                        generateTelecallerButtons('updateClientTelecallerGrid', totalTelecallers);
                        
                        // Pre-freeze assigned buttons for faster response when card is opened
                        freezeAssignedTelecallerButtons();
                    });
                })
                .catch(error => {
                    console.error('Error fetching telecaller settings:', error);
                    // Fallback to default 50 if settings can't be fetched
                    assignedTelecallersPromise.then(() => {
                        generateTelecallerButtons('newClientTelecallerGrid', 50);
                        generateTelecallerButtons('updateClientTelecallerGrid', 50);
                        
                        // Pre-freeze assigned buttons for faster response when card is opened
                        freezeAssignedTelecallerButtons();
                    });
                });
            
            // Add client button
            document.getElementById('addClientBtn').addEventListener('click', function() {
                // Get selected telecaller IDs
                const selectedButtons = document.querySelectorAll('#newClientTelecallerGrid .telecaller-button.selected');
                const includedButtons = Array.from(selectedButtons).map(button => 
                    parseInt(button.getAttribute('data-telecaller-id'))
                );
                
                // Get form values
                const clientName = document.getElementById('clientName').value;
                const clientPhone = document.getElementById('clientPhone').value;
                
                // Validate form
                if (!clientName || !clientPhone || includedButtons.length === 0) {
                    alert('Please fill in all fields and select at least one telecaller');
                    return;
                }
                
                // Get the next client ID (client1, client2, etc.)
                firebase.database().ref('clients').once('value')
                    .then(snapshot => {
                        const clients = snapshot.val() || {};
                        let maxClientNumber = 0;
                        
                        // Find the highest client number
                        Object.keys(clients).forEach(key => {
                            if (key.startsWith('client')) {
                                const clientNumber = parseInt(key.replace('client', ''));
                                if (!isNaN(clientNumber) && clientNumber > maxClientNumber) {
                                    maxClientNumber = clientNumber;
                                }
                            }
                        });
                        
                        // Create the new client ID
                        const clientId = 'client' + (maxClientNumber + 1);
                        
                        // Create a proper array structure for includedButtons
                        const clientData = {
                    name: clientName,
                            phoneNumber: clientPhone
                        };
                        
                        // First save the client without includedButtons
                        firebase.database().ref('clients/' + clientId).set(clientData)
                            .then(() => {
                                // Then add includedButtons as a separate operation to maintain array format
                                const updates = {};
                                updates['clients/' + clientId + '/includedButtons'] = includedButtons;
                                
                                return firebase.database().ref().update(updates);
                            })
                            .then(() => {
                                alert('Client added successfully!');
                
                // Reset form
                document.getElementById('clientName').value = '';
                document.getElementById('clientPhone').value = '';
                resetTelecallerButtons('newClientTelecallerGrid');
                
                // Collapse the card
                document.getElementById('addClientContent').classList.remove('active');
                                
                                // Refresh the clients list
                                fetchClients();
                                
                                // Update global assigned telecallers
                                return fetchAllAssignedTelecallers();
                            })
                            .catch((error) => {
                                console.error('Error adding client:', error);
                                alert('Error adding client: ' + error.message);
                            });
                    })
                    .catch(error => {
                        console.error('Error getting client count:', error);
                        alert('Error adding client: ' + error.message);
                    });
            });
            
            // Update client button
            document.getElementById('updateClientBtn').addEventListener('click', function() {
                // Get the client ID from the button attribute
                const clientId = this.getAttribute('data-client-id');
                if (!clientId) {
                    alert('No client selected');
                    return;
                }
                
                // Get selected telecaller IDs
                const selectedButtons = document.querySelectorAll('#updateClientTelecallerGrid .telecaller-button.selected');
                const includedButtons = Array.from(selectedButtons).map(button => 
                    parseInt(button.getAttribute('data-telecaller-id'))
                );
                
                // Get form values
                const clientName = document.getElementById('updateClientName').value;
                const clientPhone = document.getElementById('updateClientPhone').value;
                
                // Validate form
                if (!clientName || !clientPhone || includedButtons.length === 0) {
                    alert('Please fill in all fields and select at least one telecaller');
                    return;
                }
                
                // First update the basic client data
                firebase.database().ref('clients/' + clientId).update({
                    name: clientName,
                    phoneNumber: clientPhone
                })
                .then(() => {
                    // Then update includedButtons separately to maintain array format
                    const updates = {};
                    updates['clients/' + clientId + '/includedButtons'] = includedButtons;
                    
                    return firebase.database().ref().update(updates);
                })
                .then(() => {
                    alert('Client updated successfully!');
                
                // Update the telecaller names list to reflect any changes
                updateSelectedTelecallersList(includedButtons);
                    
                    // Refresh the clients list
                    fetchClients();
                    
                    // Update global assigned telecallers
                    return fetchAllAssignedTelecallers();
                })
                .catch((error) => {
                    console.error('Error updating client:', error);
                    alert('Error updating client: ' + error.message);
                });
            });
            
            // Fetch current telecaller limit
            fetchTelecallerSettings();
            
            // Update Telecaller Settings button
            document.getElementById('updateTelecallerLimitBtn').addEventListener('click', function() {
                const limitInput = document.getElementById('telecallerLimit');
                const newLimit = parseInt(limitInput.value);
                
                if (isNaN(newLimit) || newLimit < 1) {
                    alert('Please enter a valid telecaller limit (minimum 1)');
                    return;
                }
                
                // Create number words mapping based on the limit
                const numberWords = generateNumberWords(newLimit);
                
                // Save settings to Firebase
                const updates = {};
                updates['telecaller_settings/total_telecallers_count'] = newLimit;
                updates['telecaller_settings/number_words'] = numberWords;
                
                firebase.database().ref().update(updates)
                    .then(() => {
                        alert('Telecaller settings updated successfully!');
                        document.getElementById('currentTelecallerLimit').textContent = newLimit;
                        
                        // Collapse the card
                        document.getElementById('telecallerSettingsContent').classList.remove('active');
                        
                        // Regenerate telecaller buttons with new limit
                        generateTelecallerButtons('newClientTelecallerGrid', newLimit);
                        generateTelecallerButtons('updateClientTelecallerGrid', newLimit);
                        
                        // Pre-freeze assigned buttons
                        freezeAssignedTelecallerButtons();
                    })
                    .catch((error) => {
                        console.error('Error updating telecaller settings:', error);
                        alert('Error updating telecaller settings: ' + error.message);
                    });
            });
        });
        
        // Fetch telecaller settings from Firebase
        function fetchTelecallerSettings() {
            firebase.database().ref('telecaller_settings').once('value')
                .then(snapshot => {
                    const settings = snapshot.val() || {};
                    const totalTelecallers = settings.total_telecallers_count || 50;
                    
                    // Update displayed limit
                    document.getElementById('currentTelecallerLimit').textContent = totalTelecallers;
                    
                    // Update input field with current value
                    document.getElementById('telecallerLimit').value = totalTelecallers;
                })
                .catch(error => {
                    console.error('Error fetching telecaller settings:', error);
                });
        }
        
        // Generate number words mapping
        function generateNumberWords(limit) {
            const numberWords = {};
            
            // Add basic words
            numberWords["0"] = "Zero";
            numberWords["1"] = "One";
            numberWords["2"] = "Two";
            numberWords["3"] = "Three";
            numberWords["4"] = "Four";
            numberWords["5"] = "Five";
            numberWords["6"] = "Six";
            numberWords["7"] = "Seven";
            numberWords["8"] = "Eight";
            numberWords["9"] = "Nine";
            numberWords["10"] = "Ten";
            numberWords["11"] = "Eleven";
            numberWords["12"] = "Twelve";
            numberWords["13"] = "Thirteen";
            numberWords["14"] = "Fourteen";
            numberWords["15"] = "Fifteen";
            numberWords["16"] = "Sixteen";
            numberWords["17"] = "Seventeen";
            numberWords["18"] = "Eighteen";
            numberWords["19"] = "Nineteen";
            numberWords["20"] = "Twenty";
            
            // Generate words for 21 and above
            if (limit > 20) {
                const tens = ["Twenty", "Thirty", "Forty", "Fifty", "Sixty", "Seventy", "Eighty", "Ninety"];
                
                for (let i = 21; i <= limit; i++) {
                    if (i <= 99) {
                        const tensDigit = Math.floor(i / 10);
                        const onesDigit = i % 10;
                        
                        if (onesDigit === 0) {
                            // For multiples of 10 (30, 40, etc.)
                            numberWords[i.toString()] = tens[tensDigit - 2];
                        } else {
                            // For other numbers (21, 32, etc.)
                            numberWords[i.toString()] = tens[tensDigit - 2] + numberWords[onesDigit.toString()];
                        }
                    }
                }
            }
            
            return numberWords;
        }

        // Update telecaller counts for a specific container
        function updateTelecallerCounts(containerId) {
            const container = document.getElementById(containerId);
            const gridId = containerId === 'addClientContent' ? 'newClientTelecallerGrid' : 'updateClientTelecallerGrid';
            const countPrefix = containerId === 'addClientContent' ? 'newClient' : 'updateClient';
            
            const totalButtons = document.querySelectorAll(`#${gridId} .telecaller-button`).length;
            const availableButtons = document.querySelectorAll(`#${gridId} .telecaller-button.available`).length;
            const selectedButtons = document.querySelectorAll(`#${gridId} .telecaller-button.selected`).length;
            const frozenButtons = document.querySelectorAll(`#${gridId} .telecaller-button.frozen`).length;
            
            // Update the count displays
            document.getElementById(`${countPrefix}AvailableCount`).textContent = availableButtons;
            document.getElementById(`${countPrefix}SelectedCount`).textContent = selectedButtons;
            document.getElementById(`${countPrefix}AssignedCount`).textContent = frozenButtons;
        }

        // Generate simple math CAPTCHA for telecaller selection security
        function generateMathCaptcha(isAddition) {
            // Generate single-digit numbers
            const num1 = Math.floor(Math.random() * 9) + 1; // 1-9
            const num2 = Math.floor(Math.random() * 9) + 1; // 1-9
            
            // For addition
            if (isAddition) {
                return {
                    question: `${num1} + ${num2} = ?`,
                    answer: num1 + num2
                };
            } 
            // For subtraction (ensure positive result)
            else {
                const larger = Math.max(num1, num2);
                const smaller = Math.min(num1, num2);
                return {
                    question: `${larger} - ${smaller} = ?`,
                    answer: larger - smaller
                };
            }
        }

        // Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(error => {
                        console.log('ServiceWorker registration failed: ', error);
                    });
            });
        }
        
        // Add offline detection
        window.addEventListener('online', handleConnectionChange);
        window.addEventListener('offline', handleConnectionChange);
        
        function handleConnectionChange(event) {
            if (navigator.onLine) {
                document.body.classList.remove('offline');
                // Resync with Firebase when coming back online
                fetchAllAssignedTelecallers().then(() => {
                    fetchClients();
                    fetchTelecallerNames();
                });
            } else {
                document.body.classList.add('offline');
                // Add a notification that the app is offline
                showOfflineNotification();
            }
        }
        
        function showOfflineNotification() {
            const notification = document.createElement('div');
            notification.textContent = 'You are currently offline. Some features may be limited.';
            notification.style.position = 'fixed';
            notification.style.bottom = '20px';
            notification.style.left = '50%';
            notification.style.transform = 'translateX(-50%)';
            notification.style.backgroundColor = '#e74c3c';
            notification.style.color = 'white';
            notification.style.padding = '10px 20px';
            notification.style.borderRadius = '5px';
            notification.style.zIndex = '1000';
            notification.id = 'offline-notification';
            
            // Remove any existing notification first
            const existingNotification = document.getElementById('offline-notification');
            if (existingNotification) {
                existingNotification.remove();
            }
            
            document.body.appendChild(notification);
        }
        
        // Add "Add to Home Screen" promotion
        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent Chrome 76+ from automatically showing the prompt
            e.preventDefault();
            // Stash the event so it can be triggered later
            deferredPrompt = e;
            
            // Show the install button after a delay
            setTimeout(() => {
                showInstallPromotion();
            }, 3000);
        });
        
        function showInstallPromotion() {
            if (!deferredPrompt) return;
            
            const promotion = document.createElement('div');
            promotion.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: space-between; gap: 10px;">
                    <span>Install this app on your device</span>
                    <button id="install-button" style="background-color: var(--accent-color); border: none; color: white; padding: 8px 12px; border-radius: 4px; cursor: pointer;">Install</button>
                    <button id="close-promo-button" style="background: none; border: none; color: white; cursor: pointer; font-size: 20px;">&times;</button>
                </div>
            `;
            promotion.style.position = 'fixed';
            promotion.style.top = '20px';
            promotion.style.left = '50%';
            promotion.style.transform = 'translateX(-50%)';
            promotion.style.backgroundColor = '#333';
            promotion.style.color = 'white';
            promotion.style.padding = '15px 20px';
            promotion.style.borderRadius = '5px';
            promotion.style.zIndex = '1000';
            promotion.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.15)';
            promotion.id = 'install-promotion';
            
            // Remove any existing promotion first
            const existingPromotion = document.getElementById('install-promotion');
            if (existingPromotion) {
                existingPromotion.remove();
            }
            
            document.body.appendChild(promotion);
            
            // Set up button event listeners
            document.getElementById('install-button').addEventListener('click', () => {
                // Hide the promotion
                promotion.style.display = 'none';
                // Show the browser install prompt
                deferredPrompt.prompt();
                // Wait for the user to respond to the prompt
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the install prompt');
                    } else {
                        console.log('User dismissed the install prompt');
                    }
                    // Clear the deferred prompt variable
                    deferredPrompt = null;
                });
            });
            
            document.getElementById('close-promo-button').addEventListener('click', () => {
                promotion.style.display = 'none';
            });
        }
    </script>
</body>
</html> 